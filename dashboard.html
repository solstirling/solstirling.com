<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="projects-data.js"></script>
  <script src="supabase-config.js"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans min-h-screen">
  <main class="container mx-auto px-4 py-8">
    <section id="config-warning" class="hidden max-w-2xl mx-auto bg-yellow-900/30 border border-yellow-700 rounded-xl p-6 mb-6">
      <h1 class="text-xl font-bold text-yellow-200 mb-2">Setup Required</h1>
      <p class="text-yellow-100 text-sm">Create <code>supabase-config.js</code> from <code>supabase-config.example.js</code> with your Supabase URL and anon key, then refresh.</p>
    </section>

    <section id="auth-panel" class="max-w-xl mx-auto bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-xl">
      <h1 class="text-2xl font-bold text-white mb-3">Private Dashboard Login</h1>
      <p class="text-gray-400 mb-4">Sign in with your Supabase account to manage drafts and publish live projects.</p>
      <form id="auth-form" class="space-y-3">
        <div>
          <label class="text-sm text-gray-300">Email</label>
          <input id="email" type="email" required class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-gray-100">
        </div>
        <div>
          <label class="text-sm text-gray-300">Password</label>
          <input id="password" type="password" required class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2 text-gray-100">
        </div>
        <button type="submit" class="w-full bg-sky-600 hover:bg-sky-500 transition-colors text-white font-semibold py-2 rounded-md">Sign In</button>
      </form>
      <p id="auth-error" class="text-red-400 text-sm mt-3 hidden"></p>
    </section>

    <section id="dashboard" class="hidden">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
          <h2 class="text-3xl font-bold text-white">Project Dashboard</h2>
          <p class="text-gray-400">Published list is live. Editing published creates/updates a draft until you publish.</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="sync-btn" class="inline-block px-4 py-2 bg-gray-800 border border-gray-700 rounded-md hover:bg-gray-700 transition-colors">Sync Now</button>
          <a href="preview.html" class="inline-block px-4 py-2 bg-sky-700 border border-sky-600 rounded-md hover:bg-sky-600 transition-colors">Preview Draft</a>
          <a href="index.html" class="inline-block px-4 py-2 bg-gray-800 border border-gray-700 rounded-md hover:bg-gray-700 transition-colors">View Live Site</a>
          <button id="publish-btn" class="inline-block px-4 py-2 bg-green-700 hover:bg-green-600 rounded-md transition-colors">Publish Draft Changes</button>
          <button id="logout-btn" class="inline-block px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-md transition-colors">Sign Out</button>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <section class="xl:col-span-2 bg-gray-900 border border-gray-800 rounded-xl p-5">
          <h3 id="form-title" class="text-xl font-semibold text-white mb-4">Add Draft Project</h3>
          <form id="project-form" class="space-y-3">
            <input id="project-id" type="hidden">

            <div>
              <label class="text-sm text-gray-300">Title</label>
              <input id="title" required class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
            </div>

            <div>
              <label class="text-sm text-gray-300">Project Slug</label>
              <input id="project-slug" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2" placeholder="auto-generated from title if blank">
            </div>

            <div>
              <label class="text-sm text-gray-300">Description</label>
              <textarea id="description" rows="3" required class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2"></textarea>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-300">Status</label>
                <select id="status" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
                  <option>WIP</option>
                  <option>Completed</option>
                  <option>Planned</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-300">Badge Color</label>
                <select id="status-color" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
                  <option value="blue">Blue</option>
                  <option value="green">Green</option>
                  <option value="yellow">Yellow</option>
                  <option value="gray">Gray</option>
                  <option value="red">Red</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-300">Media Type</label>
                <select id="media-type" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
                  <option value="image">Image</option>
                  <option value="video">Video</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-300">Sort Order</label>
                <input id="sort-order" type="number" min="0" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2" value="0">
              </div>
            </div>

            <div>
              <label class="text-sm text-gray-300">Media URL/Path</label>
              <input id="media-src" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2" placeholder="Optional for text-only project">
            </div>

            <div>
              <label class="text-sm text-gray-300">Video Poster (optional)</label>
              <input id="media-poster" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
            </div>

            <div>
              <label class="text-sm text-gray-300">Alt Text</label>
              <input id="media-alt" class="w-full mt-1 bg-gray-950 border border-gray-700 rounded-md px-3 py-2">
            </div>

            <div class="flex gap-2 pt-2">
              <button type="submit" class="bg-sky-600 hover:bg-sky-500 px-4 py-2 rounded-md font-semibold transition-colors">Save Draft</button>
              <button type="button" id="cancel-edit" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md transition-colors hidden">Cancel Edit</button>
            </div>
          </form>

          <p id="save-status" class="text-sm text-sky-400 mt-3 hidden">Draft saved.</p>
          <p id="publish-status" class="text-sm text-green-400 mt-2 hidden">Draft changes published and removed from draft list.</p>
          <p id="dash-error" class="text-sm text-red-400 mt-2 hidden"></p>
        </section>

        <section class="space-y-4">
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <h3 class="text-lg font-semibold text-white mb-3">Draft Projects</h3>
            <div id="draft-list" class="space-y-3"></div>
          </div>
          <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
            <h3 class="text-lg font-semibold text-white mb-3">Published Projects</h3>
            <div id="published-list" class="space-y-3"></div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <script>
    const SITE_SLUG = (window.SUPABASE_CONFIG && window.SUPABASE_CONFIG.siteSlug) || 'solstirling.com';
    const authPanel = document.getElementById('auth-panel');
    const dashboard = document.getElementById('dashboard');
    const configWarning = document.getElementById('config-warning');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const dashError = document.getElementById('dash-error');
    const saveStatus = document.getElementById('save-status');
    const publishStatus = document.getElementById('publish-status');
    const projectForm = document.getElementById('project-form');
    const formTitle = document.getElementById('form-title');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const draftList = document.getElementById('draft-list');
    const publishedList = document.getElementById('published-list');
    const publishBtn = document.getElementById('publish-btn');
    const syncBtn = document.getElementById('sync-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const fields = {
      id: document.getElementById('project-id'),
      slug: document.getElementById('project-slug'),
      title: document.getElementById('title'),
      description: document.getElementById('description'),
      status: document.getElementById('status'),
      statusColor: document.getElementById('status-color'),
      mediaType: document.getElementById('media-type'),
      mediaSrc: document.getElementById('media-src'),
      mediaPoster: document.getElementById('media-poster'),
      mediaAlt: document.getElementById('media-alt'),
      sortOrder: document.getElementById('sort-order')
    };

    let client = null;
    let user = null;
    let draftProjects = [];
    let publishedProjects = [];
    let syncIntervalId = null;

    function showError(el, message) {
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideError(el) {
      el.classList.add('hidden');
      el.textContent = '';
    }

    function showTempMessage(el) {
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 1800);
    }

    function slugify(value) {
      return String(value || '').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 50);
    }

    function badgeClass(color) {
      if (color === 'green') return 'bg-green-600';
      if (color === 'yellow') return 'bg-yellow-600';
      if (color === 'gray') return 'bg-gray-600';
      if (color === 'red') return 'bg-red-600';
      return 'bg-blue-600';
    }

    function autoLink(projectId, source) {
      return `project.html?project=${encodeURIComponent(projectId)}&from=${encodeURIComponent(source || 'dashboard')}`;
    }

    function mapRowToProject(row, idx) {
      return window.PortfolioProjects.sanitizeProject(
        {
          id: row.project_key,
          title: row.title,
          description: row.description,
          link: row.link,
          status: row.status,
          statusColor: row.status_color,
          mediaType: row.media_type,
          mediaSrc: row.media_src,
          mediaAlt: row.media_alt,
          mediaPoster: row.media_poster,
          sortOrder: row.sort_order
        },
        idx
      );
    }

    function fillFormFromProject(project, modeLabel) {
      fields.id.value = project.id;
      fields.slug.value = project.id;
      fields.title.value = project.title;
      fields.description.value = project.description;
      fields.status.value = project.status;
      fields.statusColor.value = project.statusColor;
      fields.mediaType.value = project.mediaType;
      fields.mediaSrc.value = project.mediaSrc || '';
      fields.mediaPoster.value = project.mediaPoster || '';
      fields.mediaAlt.value = project.mediaAlt || '';
      fields.sortOrder.value = project.sortOrder;
      formTitle.textContent = modeLabel;
      cancelEditBtn.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
      projectForm.reset();
      fields.id.value = '';
      fields.status.value = 'WIP';
      fields.statusColor.value = 'blue';
      fields.mediaType.value = 'image';
      fields.sortOrder.value = draftProjects.length;
      formTitle.textContent = 'Add Draft Project';
      cancelEditBtn.classList.add('hidden');
    }

    function renderDraftList() {
      const ordered = [...draftProjects].sort((a, b) => a.sortOrder - b.sortOrder);
      if (!ordered.length) {
        draftList.innerHTML = '<p class="text-gray-400">No draft projects yet.</p>';
        return;
      }

      draftList.innerHTML = ordered
        .map((p) => `
          <div class="border border-gray-800 rounded-lg p-3 bg-gray-950">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h4 class="font-semibold text-white">${p.title}</h4>
                <a href="${autoLink(p.id, 'dashboard-draft')}" class="text-xs text-sky-300 hover:text-sky-200">${autoLink(p.id, 'dashboard-draft')}</a>
                <p class="text-xs text-gray-400 mt-1">Order: ${p.sortOrder}</p>
                <div class="mt-2 inline-block px-2 py-1 text-xs text-white rounded ${badgeClass(p.statusColor)}">${p.status}</div>
              </div>
              <div class="flex flex-col gap-2">
                <button class="edit-draft-btn bg-gray-800 hover:bg-gray-700 text-xs px-3 py-1 rounded" data-id="${p.id}">Edit</button>
                <button class="delete-draft-btn bg-red-700 hover:bg-red-600 text-xs px-3 py-1 rounded" data-id="${p.id}">Delete</button>
              </div>
            </div>
          </div>
        `)
        .join('');

      draftList.querySelectorAll('.edit-draft-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const p = draftProjects.find((item) => item.id === btn.dataset.id);
          if (!p) return;
          fillFormFromProject(p, 'Edit Draft Project');
        });
      });

      draftList.querySelectorAll('.delete-draft-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          hideError(dashError);
          const id = btn.dataset.id;
          const { error } = await client
            .from('portfolio_drafts')
            .delete()
            .eq('site_slug', SITE_SLUG)
            .eq('project_key', id)
            .eq('owner_id', user.id);

          if (error) {
            showError(dashError, error.message);
            return;
          }

          await refreshLists();
        });
      });
    }

    function renderPublishedList() {
      const ordered = [...publishedProjects].sort((a, b) => a.sortOrder - b.sortOrder);
      if (!ordered.length) {
        publishedList.innerHTML = '<p class="text-gray-400">Nothing published yet.</p>';
        return;
      }

      publishedList.innerHTML = ordered
        .map((p) => `
          <div class="border border-gray-800 rounded-lg p-3 bg-gray-950">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h4 class="font-semibold text-white">${p.title}</h4>
                <a href="${autoLink(p.id, 'dashboard-published')}" class="text-xs text-sky-300 hover:text-sky-200">${autoLink(p.id, 'dashboard-published')}</a>
                <p class="text-xs text-gray-400 mt-1">Order: ${p.sortOrder}</p>
                <div class="mt-2 inline-block px-2 py-1 text-xs text-white rounded ${badgeClass(p.statusColor)}">${p.status}</div>
              </div>
              <div class="flex flex-col gap-2">
                <button class="edit-published-btn bg-gray-800 hover:bg-gray-700 text-xs px-3 py-1 rounded" data-id="${p.id}">Edit</button>
              </div>
            </div>
          </div>
        `)
        .join('');

      publishedList.querySelectorAll('.edit-published-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const p = publishedProjects.find((item) => item.id === btn.dataset.id);
          if (!p) return;
          fillFormFromProject(p, 'Edit Published Project (saved as draft)');
        });
      });
    }

    async function loadDrafts() {
      const { data, error } = await client
        .from('portfolio_drafts')
        .select('project_key,title,description,link,status,status_color,media_type,media_src,media_alt,media_poster,sort_order')
        .eq('site_slug', SITE_SLUG)
        .eq('owner_id', user.id)
        .order('sort_order', { ascending: true })
        .order('updated_at', { ascending: false });

      if (error) throw error;
      draftProjects = (data || []).map(mapRowToProject);
      renderDraftList();
    }

    async function loadPublished() {
      const { data, error } = await client
        .from('portfolio_published')
        .select('project_key,title,description,link,status,status_color,media_type,media_src,media_alt,media_poster,sort_order')
        .eq('site_slug', SITE_SLUG)
        .eq('owner_id', user.id)
        .order('sort_order', { ascending: true })
        .order('published_at', { ascending: false });

      if (error) throw error;
      publishedProjects = (data || []).map(mapRowToProject);
      renderPublishedList();
    }

    async function refreshLists() {
      hideError(dashError);
      await Promise.all([loadDrafts(), loadPublished()]);
    }

    async function saveDraftProject(project) {
      const row = {
        owner_id: user.id,
        site_slug: SITE_SLUG,
        project_key: project.id,
        title: project.title,
        description: project.description,
        link: autoLink(project.id, 'live'),
        status: project.status,
        status_color: project.statusColor,
        media_type: project.mediaType,
        media_src: project.mediaSrc,
        media_alt: project.mediaAlt,
        media_poster: project.mediaPoster,
        sort_order: project.sortOrder,
        updated_at: new Date().toISOString()
      };

      const { error } = await client.from('portfolio_drafts').upsert(row, { onConflict: 'owner_id,site_slug,project_key' });
      if (error) throw error;
    }

    async function publishDrafts() {
      const orderedDrafts = [...draftProjects].sort((a, b) => a.sortOrder - b.sortOrder);
      if (!orderedDrafts.length) {
        throw new Error('No draft projects to publish.');
      }

      const rows = orderedDrafts.map((p) => ({
        owner_id: user.id,
        site_slug: SITE_SLUG,
        project_key: p.id,
        title: p.title,
        description: p.description,
        link: autoLink(p.id, 'live'),
        status: p.status,
        status_color: p.statusColor,
        media_type: p.mediaType,
        media_src: p.mediaSrc,
        media_alt: p.mediaAlt,
        media_poster: p.mediaPoster,
        sort_order: p.sortOrder,
        published_at: new Date().toISOString()
      }));

      const upsert = await client.from('portfolio_published').upsert(rows, { onConflict: 'owner_id,site_slug,project_key' });
      if (upsert.error) throw upsert.error;

      const keys = orderedDrafts.map((p) => p.id);
      const clearDrafts = await client
        .from('portfolio_drafts')
        .delete()
        .eq('site_slug', SITE_SLUG)
        .eq('owner_id', user.id)
        .in('project_key', keys);

      if (clearDrafts.error) throw clearDrafts.error;
    }

    function startAutoSync() {
      if (syncIntervalId) clearInterval(syncIntervalId);
      syncIntervalId = setInterval(async () => {
        if (!user) return;
        try {
          await refreshLists();
        } catch (_error) {
          // Keep silent during background sync.
        }
      }, 15000);
    }

    function stopAutoSync() {
      if (syncIntervalId) {
        clearInterval(syncIntervalId);
        syncIntervalId = null;
      }
    }

    async function init() {
      const cfg = window.SUPABASE_CONFIG || {};
      if (!cfg.url || !cfg.anonKey) {
        configWarning.classList.remove('hidden');
        authPanel.classList.add('hidden');
        return;
      }

      client = window.supabase.createClient(cfg.url, cfg.anonKey);
      const { data } = await client.auth.getSession();
      if (data.session && data.session.user) {
        user = data.session.user;
        authPanel.classList.add('hidden');
        dashboard.classList.remove('hidden');
        try {
          await refreshLists();
          resetForm();
          startAutoSync();
        } catch (error) {
          showError(dashError, error.message);
        }
      }
    }

    authForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      hideError(authError);

      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { data, error } = await client.auth.signInWithPassword({ email, password });

      if (error) {
        showError(authError, error.message);
        return;
      }

      user = data.user;
      authPanel.classList.add('hidden');
      dashboard.classList.remove('hidden');
      try {
        await refreshLists();
        resetForm();
        startAutoSync();
      } catch (err) {
        showError(dashError, err.message);
      }
    });

    projectForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      hideError(dashError);

      const computedId = (fields.slug.value || fields.id.value || slugify(fields.title.value)).trim();
      if (!computedId) {
        showError(dashError, 'Project slug or title is required.');
        return;
      }

      const clean = window.PortfolioProjects.sanitizeProject(
        {
          id: computedId,
          title: fields.title.value.trim(),
          description: fields.description.value.trim(),
          link: autoLink(computedId, 'live'),
          status: fields.status.value,
          statusColor: fields.statusColor.value,
          mediaType: fields.mediaType.value,
          mediaSrc: fields.mediaSrc.value.trim(),
          mediaPoster: fields.mediaPoster.value.trim(),
          mediaAlt: fields.mediaAlt.value.trim(),
          sortOrder: fields.sortOrder.value
        },
        draftProjects.length
      );

      try {
        await saveDraftProject(clean);
        await refreshLists();
        resetForm();
        showTempMessage(saveStatus);
      } catch (error) {
        showError(dashError, error.message || 'Failed to save draft.');
      }
    });

    cancelEditBtn.addEventListener('click', resetForm);

    syncBtn.addEventListener('click', async () => {
      hideError(dashError);
      try {
        await refreshLists();
      } catch (error) {
        showError(dashError, error.message || 'Sync failed.');
      }
    });

    publishBtn.addEventListener('click', async () => {
      hideError(dashError);
      try {
        await publishDrafts();
        await refreshLists();
        resetForm();
        showTempMessage(publishStatus);
      } catch (error) {
        showError(dashError, error.message || 'Publish failed.');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      stopAutoSync();
      await client.auth.signOut();
      user = null;
      draftProjects = [];
      publishedProjects = [];
      draftList.innerHTML = '';
      publishedList.innerHTML = '';
      dashboard.classList.add('hidden');
      authPanel.classList.remove('hidden');
    });

    init();
  </script>
</body>
</html>
