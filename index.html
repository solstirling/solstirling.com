<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sol Stirling Maker Portfolio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="projects-data.js"></script>
  <script src="supabase-config.js"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans min-h-screen">
  <a href="dashboard.html" class="fixed top-4 left-4 z-50 px-3 py-2 text-sm font-medium bg-gray-800/95 border border-gray-700 rounded-md text-gray-100 hover:bg-gray-700 transition-colors">Dashboard</a>

  <section class="container mx-auto px-4 py-8">
    <div class="flex justify-center mb-4">
      <img src="images/logo.png" alt="Sol Stirling Logo" class="h-20 rounded-md">
    </div>

    <div class="text-center mb-4">
      <h1 class="text-4xl font-bold text-white">welcome to my maker portfolio</h1>
      <div class="flex justify-center space-x-4 mt-4">
        <a href="https://www.linkedin.com/in/solstirling" target="_blank">
          <img src="images/linkedin.png" alt="LinkedIn" class="h-8 hover:opacity-80 transition-opacity">
        </a>
        <a href="https://discord.com/users/767132236410912828" target="_blank">
          <img src="images/discord.png" alt="Discord" class="h-8 hover:opacity-80 transition-opacity">
        </a>
        <a href="https://www.instagram.com/thesol.stirling/" target="_blank">
          <img src="images/IG.png" alt="Instagram" class="h-8 hover:opacity-80 transition-opacity">
        </a>
      </div>
    </div>

    <p class="text-center text-gray-400 text-sm mb-8">A simple catalog of all of my personal and team engineering projects.</p>
    <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <script>
    const projectsGrid = document.getElementById('projects-grid');

    const LEGACY_LINKS_BY_ID = {
      robot2025: 'robot2025.html',
      diffy: 'diffy.html',
      capstan: 'capstan.html'
    };

    const LEGACY_LINKS_BY_TITLE = {
      '2025 FRC Robot': 'robot2025.html',
      'Intro to Differential': 'diffy.html',
      'Capstan Pivot': 'capstan.html'
    };

    function escapeHtml(value) {
      return String(value || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function badgeClass(color) {
      if (color === 'green') return 'bg-green-500';
      if (color === 'yellow') return 'bg-yellow-500';
      if (color === 'gray') return 'bg-gray-500';
      if (color === 'red') return 'bg-red-500';
      return 'bg-blue-500';
    }

    function projectLink(project) {
      const legacyById = LEGACY_LINKS_BY_ID[project.id];
      if (legacyById) return legacyById;

      const legacyByTitle = LEGACY_LINKS_BY_TITLE[project.title];
      if (legacyByTitle) return legacyByTitle;

      if (project.link && project.link !== '#') return project.link;
      return `project.html?project=${encodeURIComponent(project.id)}&from=live`;
    }

    function renderMedia(project) {
      const rawSrc = project.mediaSrc || '';
      if (!rawSrc) return '';
      const src = escapeHtml(rawSrc);
      const alt = escapeHtml(project.mediaAlt || project.title || 'Project preview');

      if (project.mediaType === 'video') {
        const poster = project.mediaPoster ? ` poster="${escapeHtml(project.mediaPoster)}"` : '';
        return `<video src="${src}"${poster} class="mb-4 rounded w-full h-auto max-h-40 object-contain bg-black" muted playsinline preload="metadata"></video>`;
      }

      return `<img src="${src}" alt="${alt}" class="mb-4 rounded w-full h-auto max-h-40 object-contain">`;
    }

    function renderProjects(projects) {
      const safeProjects = projects && projects.length ? projects : window.PortfolioProjects.defaultProjects;
      projectsGrid.innerHTML = safeProjects
        .map((project) => `
          <a href="${escapeHtml(projectLink(project))}" class="block bg-gray-900 border border-gray-800 p-6 rounded-lg shadow-md hover:shadow-lg hover:border-gray-700 transition-shadow transition-colors">
            ${renderMedia(project)}
            <h2 class="text-xl font-semibold mb-2 text-white">${escapeHtml(project.title)}</h2>
            <span class="inline-block px-3 py-1 text-sm font-medium text-white ${badgeClass(project.statusColor)} rounded-full mb-2">${escapeHtml(project.status)}</span>
            <p class="text-gray-400">${escapeHtml(project.description)}</p>
          </a>
        `)
        .join('');
    }

    function mapRowToProject(row, index) {
      return window.PortfolioProjects.sanitizeProject(
        {
          id: row.project_key,
          title: row.title,
          status: row.status,
          statusColor: row.status_color,
          description: row.description,
          link: row.link,
          mediaType: row.media_type,
          mediaSrc: row.media_src,
          mediaAlt: row.media_alt,
          mediaPoster: row.media_poster,
          sortOrder: row.sort_order
        },
        index
      );
    }

    async function loadPublishedProjects() {
      const cfg = window.SUPABASE_CONFIG || {};
      if (!cfg.url || !cfg.anonKey) {
        renderProjects(window.PortfolioProjects.defaultProjects);
        return;
      }

      const client = window.supabase.createClient(cfg.url, cfg.anonKey);
      const { data, error } = await client
        .from('portfolio_published')
        .select('project_key,title,description,link,status,status_color,media_type,media_src,media_alt,media_poster,sort_order')
        .eq('site_slug', cfg.siteSlug || 'solstirling.com')
        .order('sort_order', { ascending: true })
        .order('published_at', { ascending: false });

      if (error) {
        console.error('Failed to load published projects', error);
        renderProjects(window.PortfolioProjects.defaultProjects);
        return;
      }

      renderProjects((data || []).map(mapRowToProject));
    }

    loadPublishedProjects();
  </script>
</body>
</html>
